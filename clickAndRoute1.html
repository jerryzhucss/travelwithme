<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="initial-scale=1,maximum-scale=1,user-scalable=no"
    />
    <!--
  ArcGIS API for JavaScript, https://js.arcgis.com
  For more information about the tasks-
 sample, read the original sample description at developers.arcgis.com.
  https://developers.arcgis.com/javascript/latest/sample-code/tasks-route/index.html
  -->
<title>RouteTask - 4.12</title>
    <link
      rel="stylesheet"
      href="https://js.arcgis.com/4.12/esri/themes/light/main.css"
    />
    <script src="https://js.arcgis.com/4.12/"></script>
    <style>
      html,
      body,
      #viewDiv {
        padding: 0;
        margin: 0;
        height: 100%;
        width: 100%;
      }
      #paneDiv {
        position: absolute;
        top: 10px;
        left: 62px;
        padding: 0 12px 0 12px;
        background-color: rgba(0, 0, 0, 0.5);
        color: white;
      }
      
    </style>

    <link
      rel="stylesheet"
      href="https://js.arcgis.com/4.12/esri/themes/light/main.css"
    />
    <script src="https://js.arcgis.com/4.12/"></script>

    <script>
      require([
        "esri/Map",
        "esri/views/MapView",
        "esri/Graphic",
        "esri/layers/GraphicsLayer",
        "esri/tasks/RouteTask",
        "esri/widgets/Directions",
        "esri/tasks/support/RouteParameters",
        "esri/tasks/support/FeatureSet",
         "esri/widgets/Search",
         "esri/support/actions/ActionButton",
         "esri/layers/FeatureLayer",
        "esri/widgets/Bookmarks",
        "esri/webmap/Bookmark",
        "esri/widgets/Editor",
        "esri/popup/content/AttachmentsContent",
        "esri/popup/content/TextContent"
      ], function(
        Map,
        MapView,
        Graphic,
        GraphicsLayer,
        RouteTask,
        Directions,
        RouteParameters,
        FeatureSet,
        Search,
        ActionButton,
        FeatureLayer, 
        Bookmarks, 
        Bookmark,
        Editor,
        AttachmentsContent,
        TextContent
      ) {
        const category = document.getElementById("category").text;

        // Creating the Basic Routing Functions
        var routeTask = new RouteTask({
          url:
           "https://utility.arcgis.com/usrsvcs/appservices/a6bR1egUty1q6MmN/rest/services/World/Route/NAServer/Route_World"
        });
        // The stops and route result will be stored in this layer
        var routeLayer = new GraphicsLayer();
        
        // Setup the route parameters
        var routeParams = new RouteParameters({
          stops: new FeatureSet(),
          outSpatialReference: {
            // autocasts as new SpatialReference()
            wkid: 3857
          }
        });
        routeParams.findBestSequence = true;
        routeParams.preserveFirstStop = true;
        routeParams.preserveLastStop = true;
        routeParams.returnStops = true;

        // Create the Symbologies on Map
        var stopSymbol = {
          type: "simple-marker", // autocasts as new SimpleMarkerSymbol()
          style: "cross",
          size: 15,
          outline: {
            // autocasts as new SimpleLineSymbol()
            width: 4
          }
        };
        // Define the symbology used to display the route
        var routeSymbol = {
          type: "simple-line", // autocasts as SimpleLineSymbol()
          color: [0, 0, 255, 0.5],
          width: 5
        };
        var map = new Map({
          basemap: "streets",
          layers: [routeLayer] // Add the route layer to the map
        });
        var view = new MapView({
          container: "viewDiv", // Reference to the scene div created in step 5
          map: map, // Reference to the map object created before the scene
          center: [-118.2437,34.0522],
          zoom: 12
        });
        
        var addButton={
          title:"add stop",
          id:"add stop",
        }

        let editor, features;

const editThisAction = {
  title: "Edit feature",
  id: "edit-this",
  className: "esri-icon-edit"
};
        var searchWidget = new Search({
          view: view,
          popupTemplate:
          {
           // title:"template",
            actions:
              [
                {
                  id:"add stop",
                  title:"add stop"
                }
              ]   
          }
        });
        
        searchWidget.popupTemplate.actions.push(editThisAction);
        //remove the current pop up and enable an editor
        function editThis() {
            // If the EditorViewModel's activeWorkflow is null, make the popup not visible
            if (!editor.viewModel.activeWorkFlow) {
              view.popup.visible = false;
              /*{
                geometry: point,
                longitude: view.popup.selectedFeature.longitude,
                latitude: view.popup.selectedFeature.latitude,
                attributes: 
                {
                  "name": "",
               //   "family": "Pinaceae",
               //   "count": 126
                },
                symbol: new SimpleMarkerSymbol
                ({
                  style: "square",
                  color: "blue",
                  size: "8px"
                })

              }*/
              //var thisFeature = new Graphic
              //();
              editor.startUpdateWorkflowAtFeatureEdit(view.popup.selectedFeature);
              view.ui.add(editor, "bottom-left");
              view.popup.spinnerEnabled = false;
            }

            // We need to set a timeout to ensure the editor widget is fully rendered. We
            // then grab it from the DOM stack
            setTimeout(function() {

              // Use the editor's back button as a way to cancel out of editing
              let arrComp = editor.domNode.getElementsByClassName(
                "esri-editor__back-button esri-interactive"
              
             );
             
              if (arrComp.length === 1) {
                arrComp[0].setAttribute(
                  "title",
                  "Cancel edits, return to popup"
                );
                // Add a listerner to listen for when the editor's back button is clicked
                arrComp[0].addEventListener("click", function(evt) {
                  // Prevent the default behavior for the back button and instead remove the editor and reopen the popup
                  evt.preventDefault();
                  view.ui.remove(editor);
                  view.popup.open({
                    features: features
                  });
                });
              }
            }, 150);
          }

       view.popup.on("trigger-action", function(event) 
       {
  
            if (event.action.id == "add stop") 
            {        
              addStop(searchWidget.selectedResult);
              var routeFLayer = new FeatureLayer(routeLayer);
            }
            else if (event.action.id === "edit-this") 
            {
              editThis();
            }
       });
        view.ui.add(searchWidget, {
            position: "bottom-right",
            index: 2
        });
     



        // Create a popupTemplate for the featurelayer and pass in a function to set its content and specify an action to handle editing the selected feature
   //     const template = {
     //     title: "Trail name: {trailName}",
        //  content: difficultyLevel,
         // fieldInfos: [
      //      {
         //     fieldName: "trailName"
         //   },
         //   {
         //     fieldName: "difficulty"
        //    }
         // ],
      //    actions: [editThisAction]
      //  };

        // Function that creates two popup elements for the template: attachments and text
        function difficultyLevel(feature) {
          // 1. Set how the attachments should display within the popup
      //    const attachmentsElement = new AttachmentsContent({
      //      displayType: "list"
       //   });

          const textElement = new TextContent();

          const level = feature.graphic.attributes.difficulty;
          const green =
            "<b><span style='color:green'>" + level + "</span></b>.";
          const purple =
            "<b><span style='color:purple'>" + level + "</span></b>.";
          const red = "<b><span style='color:red'>" + level + "</span></b>.";

          switch (level) {
            case "easy":
              textElement.text =
                "The {trailName} trail has a difficulty level of " + green;
              return [textElement, attachmentsElement];
              break;
            case "medium":
              textElement.text =
                "The {trailName} trail has a difficulty level of " + purple;
              return [textElement, attachmentsElement];
              break;
            case "hard":
              textElement.text =
                "The {trailName} trail has a difficulty level of " + red;
              return [textElement, attachmentsElement];
          }
        }



        const symbolCats = [
          "post-office",
          "atm",
          "place-of-worship",
          "park",
          "school",
          "hospital",
          "fire-station",
          "playground",
          "shopping-center",
          "campground",
          "golf-course",
          "library",
          "city-hall",
          "beach",
          "police-station",
          "subway-station",
          "train-station",
          "cemetery",
          "trail",
          "radio-tower",
          "museum",
          "airport",
          "live-music-venue",
          "sports-complex",
          "ferry"
        ];

        rendererInfos = symbolCats.map((symCat) => {
          return {
            value: symCat,
            symbol: {
              type: "web-style",
              name: symCat,
              styleName: "Esri2DPointSymbolsStyle"
            },
            label: symCat
          };
        });

        const scale = 36112;

        const renderer = {
          type: "unique-value", // autocasts as new UniqueValueRenderer()
          valueExpression: category,
          valueExpressionTitle: "Symbol Categories",
          uniqueValueInfos: rendererInfos,
          visualVariables: [
            {
              type: "size",
              valueExpression: "$view.scale",
              stops: [
                { value: scale, size: 20 },
                { value: scale * 2, size: 15 },
                { value: scale * 4, size: 10 },
                { value: scale * 8, size: 5 },
                { value: scale * 16, size: 2 },
                { value: scale * 32, size: 1 }
              ]
            }
          ]
        };
        const featureLayer = new FeatureLayer({
          url:
            "https://services.arcgis.com/Wl7Y1m92PbjtJs5n/arcgis/rest/services/LA_County_Points_of_Interest/FeatureServer",
          renderer: renderer,
          outFields: ["*"],
          popupTemplate: {
            title: "{Name}",
            content: [
              {
                type: "fields",
                fieldInfos: [
                  {
                    fieldName: "cat2",
                    label: "Category"
                  },
                  {
                    fieldName: "addrln1",
                    label: "Address"
                  },
                  {
                    fieldName: "city",
                    label: "City"
                  },
                  {
                    fieldName: "phones",
                    label: "Phone number"
                  },
                  {
                    fieldName: "link",
                    label: "Link"
                  }
                ]
              }
            ],
            actions: [editThisAction]
          }
        });

        map.add(featureLayer);


        const bookmarks = new Bookmarks({
          view: view,
          bookmarks: [
            new Bookmark({
              name: "Angeles National Forest",
              extent: {
                spatialReference: {
                  wkid: 102100
                },
                xmin: -13139131.948889678,
                ymin: 4047767.23531948,
                xmax: -13092887.54677721,
                ymax: 4090610.189673263
              }
            }),
            new Bookmark({
              name: "Crystal Lake",
              extent: {
                spatialReference: {
                  wkid: 102100
                },
                xmin: -13125852.551697943,
                ymin: 4066904.1101411926,
                xmax: -13114291.451169826,
                ymax: 4077614.8487296384
              }
            }),
            new Bookmark({
              name: "San Fernando",
              extent: {
                spatialReference: {
                  latestWkid: 3857,
                  wkid: 102100
                },
                xmin: -13185668.186639601,
                ymin: 4066176.418652561,
                xmax: -13183855.195875114,
                ymax: 4067515.260976006
              }
            })
          ]
        });

        // Add the widget to the top-right corner of the view
     //   view.ui.add(bookmarks, {
     //     position: "top-right"
     //   });


        function Stop(earlyArrival, lateArrival, minTime, maxTime, preference){
          this.earlyArrival = earlyArrival;
          this.lateArrival = lateArrival;
          this.minTime = minTime;
          this.maxTime = maxTime;
          this.preference = preference;
        }

        // Creating Routing Functions
        var firstStop, lastStop;
        var arrStop = [];
       
          function addStop(stopPoint) {
          var stop = stopPoint.feature;
          routeLayer.add(stop);

          if (firstStop == null) {
            firstStop = stop;
          } else if (lastStop == null) {
            lastStop = stop;
          } else {
            arrStop.push(lastStop);
            lastStop = stop
          }
          if (firstStop != null && lastStop!= null) {
            solveRoute();
          }
        }

        function removeStop(stop) {
          routeLayer.remove(stop);

          if (stop == firstStop) {
            if (arrStop.length == 0 && lastStop == null) {
              firstStop = null;
            } else if (arrStop.length == 0) {
              firstStop = lastStop;
              lastStop = null;
            } else {
              firstStop = arrStop.shift();
            }
          } else if (stop == lastStop) {
            lastStop = arrStop.pop();
          } else {
            for (var i = 0; i < arrStop.length; i++) {
              if (arrStop[i] == stop) {
                arrStop.splice(i,1);
              }
            }
          }
        }


        function solveRoute() {
          //first clear routeParams so no stops
          routeParams.stops.features = [];
            routeParams.stops.features.push(firstStop);
            for (var i = 0; i < arrStop.length; i++) {
              routeParams.stops.features.push(arrStop[i]);
            }
            routeParams.stops.features.push(lastStop);

            routeTask.solve(routeParams).then(showRoute);
        }

        var prev_route;
        function showRoute(data) {
          var routeResult = data.routeResults[0].route;
          routeResult.symbol = routeSymbol;
          if (prev_route != null) {
            routeLayer.remove(prev_route);
          }
          routeLayer.add(routeResult);
          prev_route = routeResult;
        }

        
        /*const playFilter = [
          // show only points that represent vegetation
          {
            type: "value",
            field: "cat2",
            mode: "include",
            // values include low, medium and high vegetation
            values: ["playground"]
          }
          // show only points from the first return
          // (highest points in the landscape)

        ];

        const hosFilter = [
          {
            type: "value",
            field: "cat1",
            mode: "include",
            values: ["Education"]
          }
        ];*/
        
        /*view.when(function() {
          //const pcLayer = map.layers.getItemAt(0);
          const pcLayer = map.findLayerById(0);
          const radios = document.getElementsByName("filter");
          // Handle change events on radio buttons to switch to the correct renderer
          for (var i = 0; i < radios.length; i++) {
            radios[i].addEventListener("change", function(event) {
              var fieldName = event.target.value;
              switch (fieldName) {
                case "playground":
                  pcLayer.filters = playFilter;
                  break;
                case "Education":
                  pcLayer.filters = hosFilter;
                  break;
                default:
                  pcLayer.filters = [];
              }
            });
          }
        });*/

       /* view.ui.add(playFilter, {
          position: "bottom-right"
        }); */


        view.when(function() {
          // Create the Editor with the specified layer and a list of field configurations
          editor = new Editor({
            view: view,
            container: document.createElement("div"),
            layerInfos: [
              {
                layer: featureLayer,
                fieldConfig: [
                  {
                    name: "cat2",
                    label: "cat2",
                    editable: true
                  }
                 
                ]
              }
            ]
          });

         
          // Event handler that fires each time an action is clicked
     //     view.popup.on("trigger-action", function(event) {
    //        if (event.action.id === "edit-this") {
    //          editThis();
     //       }
     //     });
        });

        // Watch when the popup is visible
        view.popup.watch("visible", function(event) {
          // Check the Editor's viewModel state, if it is currently open and editing existing features, disable popups
          if (editor.viewModel.state === "editing-existing-feature") {
            view.popup.close();
          } else {
            // Grab the features of the popup
            features = view.popup.features;
          }
        });

        featureLayer.on("apply-edits", function() {
          // Once edits are applied to the layer, remove the Editor from the UI
          view.ui.remove(editor);

          // Iterate through the features
          features.forEach(function(feature) {
            // Reset the template for the feature if it was edited
            feature.popupTemplate = template;
          });

          // Open the popup again and reset its content after updates were made on the feature
          if (features) {
            view.popup.open({
              features: features
            });
          }

          // Cancel the workflow so that once edits are applied, a new popup can be displayed
          editor.viewModel.cancelWorkflow();
        });

        view.ui.add("info", {
          position: "bottom-left",
          index: 1
        });



      });
    </script>
    <script type="text/plain" id="category">
     // if($feature.cat2 == "UPS Locations" || $feature.cat2 == "USPS Mail Collection Boxes" || $feature.cat2 == "DHL Locations" || $feature.cat2 == "Federal Express Locations"){
     //   return "post-office"
    //  }
 //     if($feature.cat2=="Banking and Finance"){
 //       return "atm"
 //     }
 //     else if($feature.cat2 == "Churches"){
 //       return "place-of-worship"
  //    }
 //     else if($feature.cat2 == "Parks and Gardens"){
 //       return "park"
 //     }
    //  else if($feature.cat1 == "Education"){
   //     return "school"
    //  }
  //     if($feature.cat2 == "Mental Health Centers" ||$feature.cat2 == "Medicare and Medicaid Offices"|| $feature.cat2 == "Mental Health Counseling" || $feature.cat2== "Dental Care" || $feature.cat2 == "Health Clinics" || $feature.cat2== "Health Centers" || $feature.cat2 == "Health Education and Counseling" || $feature.cat2== "Health Screening and Testing" || $feature.cat2== "Hospitals and Medical Centers"){
  //      return "hospital"
 //     }
 //    else if($feature.cat2 == "Fire Stations"){
 //       return "fire-station"
 //     }
 //     else if($feature.cat2 == "Recreation Centers" || $feature.cat2 == "Recreation Programs" || $feature.cat2 == "Park and Ride Locations"){
  //      return "playground"
  //    }
      if($feature.cat2 == "Shopping Centers" || $feature.cat2=="Thrift Shops"){
        return "shopping-center"
      }
 //     else if($feature.cat2 == "Campgrounds"){
 //       return "campground"
//      }
 //     else if($feature.cat2 == "Golf Courses"){
//        return "golf-course"
 //     }
  //    else if($feature.cat2 == "Libraries"){
 //       return "library"
 //     }
 //     else if($feature.cat2 == "City Halls"|| $feature.cat2 == "Government Offices" || $feature.cat2 =="County Offices" || $feature.cat2 =="Probation Offices" || $feature.cat2 =="Social Security Administration"){
  //      return "city-hall"
 //     }
      else if($feature.cat2 == "Beaches and Marinas"){
        return "beach"
      }
 //     else if($feature.cat2 == "Sheriff and Police Stations"){
 //       return "police-station"
 //     }
     /* else if($feature.cat2 == "Metro Stations"){
        return "subway-station"
      }
      else if($feature.cat2 == "Metrolink Stations" || $feature.cat2 == "Amtrak Stations"){
        return "train-station"
      }*/
 //     else if($feature.cat2 == "Cemeteries"){
 //       return "cemetery"
  //    }
  //    else if($feature.cat2 == "Trails"){
 //       return "trail"
  //    }
 //     else if($feature.cat2 == "Microwave Towers" || $feature.cat2 =="Cellular Towers"){
 //       return "radio-tower"
//      }
      else if($feature.cat2 == "Museums and Aquariums"){
        return "museum"
      }
  //    else if($feature.cat2 == "Airport"){
 //       return "airport"
 //     }
      else if($feature.cat2 == "Cultural and Performing Arts Centers"){
        return "live-music-venue"
      }
 //     else if($feature.cat2 == "Sports Venues"){
  //      return "sports-complex"
 //     }
 //     else if($feature.cat2 == "Ferries"){
 //       return "ferry"
  //    }
    </script>
  </head>
  <body>
    <div id="viewDiv"></div>
    <div id="paneDiv" class="esri-widget">
        <h3>Where would you like to go? </h3>
        <input type="radio" name="filter" value="noFilter" checked /> No filter<br />
        <input type="radio" name="filter" value="playground" /> Filter plaground
        <br />
        <input type="radio" name="filter" value="hospital" /> Filter hospital
       <br />

      <div>
        <p>
        </p>
      </div>
    </div>
  </body>

</html>
