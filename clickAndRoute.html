<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="initial-scale=1,maximum-scale=1,user-scalable=no"
    />
    <!--
  ArcGIS API for JavaScript, https://js.arcgis.com
  For more information about the tasks-
 sample, read the original sample description at developers.arcgis.com.
  https://developers.arcgis.com/javascript/latest/sample-code/tasks-route/index.html
  -->
<title>RouteTask - 4.12</title>
    <style>
      html,
      body,
      #viewDiv {
        padding: 0;
        margin: 0;
        height: 100%;
        width: 100%;
      }
      #paneDiv {
        position: absolute;
        top: 10px;
        left: 62px;
        padding: 0 12px 0 12px;
        background-color: rgba(0, 0, 0, 0.5);
        color: white;
      }
    </style>

    <link
      rel="stylesheet"
      href="https://js.arcgis.com/4.12/esri/themes/light/main.css"
    />
    <script src="https://js.arcgis.com/4.12/"></script>

    <script>
      require([
        "esri/Map",
        "esri/views/MapView",
        "esri/Graphic",
        "esri/layers/GraphicsLayer",
        "esri/tasks/RouteTask",
        "esri/widgets/Directions",
        "esri/tasks/support/RouteParameters",
        "esri/tasks/support/FeatureSet",
         "esri/widgets/Search"
      ], function(
        Map,
        MapView,
        Graphic,
        GraphicsLayer,
        RouteTask,
        Directions,
        RouteParameters,
        FeatureSet,
        Search
      ) {


        // Creating the Basic Routing Functions
        var routeTask = new RouteTask({
          url:
           "https://utility.arcgis.com/usrsvcs/appservices/a6bR1egUty1q6MmN/rest/services/World/Route/NAServer/Route_World"
        });
        // The stops and route result will be stored in this layer
        var routeLayer = new GraphicsLayer();
        // Setup the route parameters
        var routeParams = new RouteParameters({
          stops: new FeatureSet(),
          outSpatialReference: {
            // autocasts as new SpatialReference()
            wkid: 3857
          }
        });
        routeParams.findBestSequence = true;
        routeParams.preserveFirstStop = true;
        routeParams.preserveLastStop = true;
        routeParams.returnStops = true;





        // Create the Symbologies on Map
        var stopSymbol = {
          type: "simple-marker", // autocasts as new SimpleMarkerSymbol()
          style: "cross",
          size: 15,
          outline: {
            // autocasts as new SimpleLineSymbol()
            width: 4
          }
        };
        // Define the symbology used to display the route
        var routeSymbol = {
          type: "simple-line", // autocasts as SimpleLineSymbol()
          color: [0, 0, 255, 0.5],
          width: 5
        };
        var map = new Map({
          basemap: "streets",
          layers: [routeLayer] // Add the route layer to the map
        });
        var view = new MapView({
          container: "viewDiv", // Reference to the scene div created in step 5
          map: map, // Reference to the map object created before the scene
          center: [-117.195, 34.057],
          zoom: 14
        });

        function Stop(earlyArrival, lateArrival, minTime, maxTime, preference){
          this.earlyArrival = earlyArrival;
          this.lateArrival = lateArrival;
          this.minTime = minTime;
          this.maxTime = maxTime;
          this.preference = preference;
        }



        // Creating Routing Functions
        var firstStop, lastStop;
        var arrStop = [];




        view.on("click", addStop);

        function addStop(event) {
          // Add a point at the location of the map click
          var stop = new Graphic({
            geometry: event.mapPoint,
            symbol: stopSymbol
          });
          routeLayer.add(stop);

          if (firstStop == null) {
            firstStop = stop;
          } else if (lastStop == null) {
            lastStop = stop;
          } else {
            arrStop.push(lastStop);
            lastStop = stop
          }
          if (firstStop != null && lastStop!= null) {
            solveRoute();
          }
        }

        function removeStop(stop) {
          routeLayer.remove(stop);

          if (stop == firstStop) {
            if (arrStop.length == 0 && lastStop == null) {
              firstStop = null;
            } else if (arrStop.length == 0) {
              firstStop = lastStop;
              lastStop = null;
            } else {
              firstStop = arrStop.shift();
            }
          } else if (stop == lastStop) {
            lastStop = arrStop.pop();
          } else {
            for (var i = 0; i < arrStop.length; i++) {
              if (arrStop[i] == stop) {
                arrStop.splice(i,1);
              }
            }
          }
        }


        function solveRoute() {
          //first clear routeParams so no stops
          routeParams.stops.features = [];
            routeParams.stops.features.push(firstStop);
            for (var i = 0; i < arrStop.length; i++) {
              routeParams.stops.features.push(arrStop[i]);
            }
            routeParams.stops.features.push(lastStop);

            routeTask.solve(routeParams).then(showRoute);
        }

        var prev_route;
        function showRoute(data) {
          var routeResult = data.routeResults[0].route;
          routeResult.symbol = routeSymbol;
          if (prev_route != null) {
            routeLayer.remove(prev_route);
          }
          routeLayer.add(routeResult);
          prev_route = routeResult;
        }

        var searchWidget = new Search({view: view});

        view.ui.add(searchWidget, {
            position: "top-left",
            index: 2
        });

      });
    </script>
  </head>
  <body>
    <div id="viewDiv"></div>
    <div id="paneDiv" class="esri-widget">
      <div>
        <p>
        </p>
      </div>
    </div>
  </body>

</html>
